# Baleen: ML Admission & Prefetching for Flash Caches

[[Paper_in_md/Baleen|Baleen]]

## 摘要

Baleen 是一个用于闪存缓存的机器学习准入和预取系统，旨在优化大规模存储系统的性能和总体拥有成本(TCO)。该系统通过创新性地使用"磁盘头时间"(Disk-head Time, DT)作为端到端吞吐量指标，以及采用"情景"(episode)框架来训练机器学习模型，实现了对闪存缓存的高效管理。实验表明，Baleen 相比现有系统可以减少 12%的峰值 DT，降低 18%的 TCO。

## 1. 引言

随着数据中心存储系统规模的不断扩大，闪存缓存被广泛用于加速对硬盘的访问。然而，现有的闪存缓存系统存在几个关键问题：

1. 缺乏模块化设计，难以适应不同的工作负载
2. 优化中间指标而非端到端性能
3. 未关注峰值性能，导致资源浪费
4. 缺乏准入策略和预取策略的协同设计

Baleen 系统通过解决这些问题，提供了一个全面的闪存缓存解决方案。

## 2. 背景与相关工作

### 2.1 闪存缓存系统

闪存缓存系统通常位于硬盘和内存之间，用于加速数据访问。现有系统如 CacheLib、Flashield 等主要关注缓存命中率的优化，但忽略了端到端性能和总体拥有成本。

### 2.2 机器学习在缓存中的应用

机器学习已被应用于缓存准入和替换策略，但现有工作主要关注单一指标（如命中率），缺乏对系统整体性能的考虑。

## 3. 磁盘头时间(DT)：端到端吞吐量指标

### 3.1 DT 定义与计算

磁盘头时间(DT)是 Baleen 提出的关键指标，用于衡量硬盘处理请求所需的时间：

```latex
DT = 请求数 × 平均寻道时间 + 传输字节数 ÷ 带宽
```

这一指标同时考虑了 IOPS（每秒输入输出操作数）和带宽，能够更准确地反映系统性能。

### 3.2 峰值 DT 与 TCO

峰值 DT 决定了系统需要的硬盘数量，直接影响总体拥有成本(TCO)。Baleen 通过优化峰值 DT 来降低 TCO：

```
TCO = 硬盘成本 × 硬盘数量 + 闪存成本 × 闪存容量
```

其中，硬盘数量由峰值 DT 决定。

## 4. Baleen 系统设计

### 4.1 系统架构

Baleen 系统由三个核心组件组成：

1. **ML 准入策略**：决定哪些数据块应该被缓存
2. **ML 预取策略**：决定何时以及预取哪些数据
3. **TCO 优化器**：根据工作负载特性选择最优的闪存写入率

![系统架构图](图1)

系统架构图展示了Baleen的三个核心组件如何协同工作：ML准入策略负责筛选哪些数据应该进入缓存；ML预取策略通过ML-When和ML-Range两个决策模型来确定预取时机和内容；TCO优化器则根据工作负载特性动态调整闪存写入率，平衡性能和成本。

### 4.2 基于情景(Episode)的机器学习框架

Baleen 创新性地提出了"情景"(episode)概念，将连续的数据访问分组，用于训练机器学习模型。这种方法有两个关键优势：

1. 避免了训练数据中热门对象的过度表示
2. 使模型能够学习数据访问的时间模式

情景定义为从一个数据块的首次访问到其被驱逐出缓存的整个过程。每个情景包含了数据块的完整生命周期，使机器学习模型能够学习到更有意义的访问模式，而不仅仅是基于单次访问做出决策。

![情景框架示意图](图2)

情景框架将数据访问序列转换为一系列情景，每个情景包含了数据块的多次访问信息，这种方式使得机器学习模型能够捕捉到时间局部性和访问模式，从而做出更准确的缓存和预取决策。

### 4.3 ML 准入策略详解

Baleen 的 ML 准入策略使用 LightGBM 模型，基于以下特征做出决策：

- **静态特征**：数据块大小、访问大小、客户端 ID 等
- **动态特征**：历史访问频率、访问间隔时间等
- **情景特征**：情景内的访问模式、时间分布等

模型输出是一个二元决策：接受或拒绝将数据块缓存到闪存中。

![ML准入策略工作流程](图3)

准入策略的核心是通过机器学习模型预测每个数据块的"价值"，即缓存该块能够减少的磁盘头时间(DT)。模型训练过程中使用了情景框架，将每个数据块的完整访问历史作为训练样本，而不是单独的访问事件。这种方法使模型能够学习到更复杂的访问模式，从而做出更准确的缓存决策。

与传统的基于规则的准入策略相比，Baleen的ML准入策略能够适应不同的工作负载特性，并且能够根据端到端性能指标(DT)而非简单的命中率来优化决策。

### 4.4 ML 预取策略详解

Baleen 的预取策略包含两个关键决策：

1. **ML-When**：决定何时进行预取

   - 每次未命中时预取
   - 每两次未命中预取
   - 部分 IOPS 命中时预取
   - 基于情景模型的 OPT 预取

2. **ML-Range**：决定预取什么内容
   - 整块预取：预取整个数据块
   - OPT-Range 预取：基于情景模型预测最优预取范围

这两个决策共同形成了 Baleen 的预取策略矩阵。

![预取策略矩阵](图4)

预取策略的核心创新在于将"何时预取"和"预取什么"这两个决策分离，并使用机器学习模型来优化这两个决策。ML-When模型通过分析历史访问模式，预测哪些未命中情况下进行预取是有益的；ML-Range模型则预测在决定预取时，应该预取数据块的哪些部分，以最大化性能收益并最小化闪存写入开销。

与传统的盲目预取策略相比，Baleen的ML预取策略能够：

1. 避免有害的预取，减少闪存写入开销
2. 精确预测需要预取的数据范围，减少不必要的数据传输
3. 根据工作负载特性动态调整预取行为

实验结果表明，ML-Range比无预取策略减少了16%的峰值DT，而ML-When则帮助系统区分有益和有害的预取，进一步提升了性能。

### 4.5 TCO 优化

Baleen-TCO 通过模拟不同闪存写入率下的系统性能，选择能够最小化 TCO 的最优写入率。这一优化考虑了闪存耐久性、硬盘成本和系统性能之间的平衡。

![TCO优化示意图](图5)

TCO优化的核心思想是找到闪存写入率与系统性能之间的最佳平衡点。闪存写入率越高，缓存效果越好，但闪存寿命缩短，更换成本增加；写入率过低，则缓存效果不佳，需要更多硬盘来满足性能需求，增加硬件成本。

Baleen-TCO通过以下步骤优化总体拥有成本：

1. 对不同的闪存写入率进行模拟，计算对应的峰值DT
2. 根据峰值DT计算所需的硬盘数量
3. 结合闪存成本和硬盘成本，计算总体TCO
4. 选择TCO最低的闪存写入率作为最优配置

实验结果表明，Baleen-TCO比基准系统节省了17-18%的TCO，证明了这种优化方法的有效性。

## 5. 实验评估

### 5.1 实验设置

- **工作负载**：来自 Meta 的 7 个生产环境跟踪数据
- **硬件**：400GB 闪存缓存、10GB 内存缓存和 36 个硬盘
- **ML 训练**：使用 LightGBM，500 轮提升，63 个叶节点
- **基准系统**：RejectX、CoinFlip、Flashield 和 CacheLib

![实验设置和工作负载特性](图6)

实验使用的工作负载具有典型的Web服务特性，包括Zipf分布的数据块访问频率和多样化的访问模式。这些工作负载来自Meta的Tectonic存储集群，代表了真实世界中的大规模存储系统访问模式。

为了确保评估的公平性，研究团队构建了一个详细的模拟器，并通过与实际系统的对比验证了其准确性。同时，实验中考虑了不同硬件配置的影响，确保结果的通用性。

### 5.2 性能结果

1. **峰值 DT 减少**：Baleen 平均减少 12%的峰值 DT，在不同工作负载上减少 5%-29%
2. **TCO 节省**：Baleen-TCO 比 RejectX 节省 18%的 TCO
3. **缓存大小减少**：在保持相同峰值 DT 的情况下，Baleen 可以减少 55%的缓存大小

![性能结果对比](图7)

实验结果显示，Baleen在所有测试的工作负载上都优于现有系统。特别是在具有高度时间局部性的工作负载上，性能提升更为显著。这证明了基于情景的机器学习框架能够有效捕捉数据访问的时间模式，从而做出更准确的缓存和预取决策。

值得注意的是，Baleen不仅在峰值DT上有显著改善，而且在平均DT上也有类似的提升，表明系统在各种负载条件下都能保持良好的性能。

### 5.3 预取策略效果

- ML-Range 比无预取策略减少 16%的峰值 DT
- ML-When 帮助 Baleen 区分有益和有害的预取
- 预取必须与良好的准入策略配合使用，否则可能适得其反

![预取策略效果分析](图8)

研究团队对Baleen的预取策略进行了详细分析，发现：

1. **选择性预取优于盲目预取**：ML-Range能够精确预测需要预取的数据范围，减少不必要的数据传输，从而显著提升性能。

2. **预取时机至关重要**：ML-When能够识别哪些未命中情况下进行预取是有益的，避免了有害的预取，减少了闪存写入开销。

3. **准入与预取协同效应**：实验表明，即使是最好的预取策略，如果没有良好的准入策略配合，也可能导致性能下降。这证明了Baleen系统设计中准入和预取策略协同优化的重要性。

4. **情景框架的关键作用**：基于情景的训练对ML预取至关重要，使模型能够学习到数据访问的时间模式，从而做出更准确的预取决策。

### 5.4 关键发现

1. 基于情景的训练对 ML 预取至关重要
2. 选择性预取比盲目预取更有效
3. 准入和预取策略的协同设计是系统性能的关键

![关键发现总结](图9)

除了上述主要发现外，研究团队还得出了以下重要结论：

1. **端到端指标的重要性**：优化中间指标（如命中率）不一定能提高端到端性能。使用DT作为端到端吞吐量指标，能够更准确地指导系统优化。

2. **峰值性能优化的价值**：优化峰值DT而非平均DT，能够更有效地降低系统TCO，因为硬盘数量由峰值需求决定。

3. **机器学习的适应性**：基于机器学习的准入和预取策略能够自动适应不同的工作负载特性，无需手动调整参数。

4. **模块化设计的优势**：Baleen的模块化设计使得系统各组件可以独立优化，同时又能协同工作，提高了系统的灵活性和可扩展性。

## 6. 结论

Baleen 通过创新性地结合机器学习准入和预取策略，以及使用端到端性能指标(DT)，成功地优化了闪存缓存系统的性能和成本。系统的模块化设计和基于情景的机器学习框架使其能够适应不同的工作负载和硬件配置。实验结果表明，Baleen 在各种工作负载上都能显著减少峰值 DT 和 TCO，证明了其在大规模存储系统中的实用价值。

![Baleen系统总结](图10)

关键创新点包括：

1. 使用"磁盘头时间"作为端到端吞吐量指标
2. 基于"情景"框架的机器学习模型训练
3. ML-When 和 ML-Range 预取策略的协同设计
4. 针对 TCO 的闪存写入率优化

这些创新使 Baleen 成为一个全面、高效的闪存缓存解决方案，为未来的存储系统设计提供了新的思路。

### 6.1 未来研究方向

尽管Baleen已经取得了显著的成果，但仍有几个值得探索的研究方向：

1. **多层次缓存协同优化**：将Baleen的方法扩展到包括内存缓存和远程缓存的多层次缓存系统中。

2. **实时学习与适应**：开发能够在线学习和适应工作负载变化的机器学习模型，进一步提高系统的适应性。

3. **硬件感知优化**：考虑新型存储硬件（如ZNS SSD、CXL内存）的特性，优化缓存策略。

4. **跨应用场景泛化**：研究如何将Baleen的方法应用于其他类型的存储系统，如分布式文件系统、对象存储等。

### 6.2 实际应用价值

Baleen系统的实际应用价值主要体现在以下几个方面：

1. **降低数据中心TCO**：通过减少所需的硬盘数量和优化闪存使用，显著降低存储系统的总体拥有成本。

2. **提高系统性能**：减少峰值DT，提高存储系统的吞吐量和响应时间。

3. **增强系统可扩展性**：模块化设计使系统能够适应不同规模的存储需求。

4. **优化资源利用**：通过机器学习模型精确预测数据访问模式，优化资源分配。

总之，Baleen代表了存储系统设计的一个重要进步，将机器学习技术与系统优化相结合，为大规模存储系统提供了一个高效、经济的解决方案。
